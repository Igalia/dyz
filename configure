#!/bin/sh

### See http://people.gnome.org/~walters/docs/build-api.txt
# buildapi-variable-no-builddir

opt_cflags=${CFLAGS}
opt_cxxflags=${CXXFLAGS}
opt_ldflags=${LDFLAGS}
opt_prefix='/usr/local'
opt_libdir=''
opt_bindir=''

# Parse arguments
while [ "${1}" ]; do
	case "${1}" in
		CFLAGS=*) opt_cflags=$(echo "${1}" | cut -d= -f2-) ;;
		CXXFLAGS=*) opt_cxxflags=$(echo "${1}" | cut -d= -f2-) ;;
		LDFLAGS=*) opt_cxxflags=$(echo "${1}" | cut -d= -f2-) ;;
		--prefix=*|-prefix=*) opt_prefix=$(echo "${1}" | cut -d= -f2-) ;;
		--prefix|-prefix) shift; opt_prefix="${1}" ;;
		--libdir=*|-libdir=*) opt_libdir=$(echo "${1}" | cut -d= -f2-) ;;
		--libdir|-libdir) shift; opt_libdir="${1}" ;;
		--bindir=*|-bindir=*) opt_bindir=$(echo "${1}" | cut -d= -f2-) ;;
		--bindir|-bindir) shift; opt_bindir="${1}" ;;
		--help|-help)
			cat <<-EOF
			usage: $0 [--options]
			Available options:

			  --help          This help message.
			  --prefix=PATH   Installation path prefix [default: /usr/local]
			  --libdir=PATH   Library installation path [default: \$prefix/lib]
			  --bindir=PATH   Binary installation path [default: \$prefix/bin]

			Also, the following relevant environment variables can be set:

			  CFLAGS    Additional command line flags to be passed to the C compiler
			  CXXFLAGS  Additional command line flags to be passed to the C++ compiler
			  LDFLAGS   Additional command line flags to be passed to the linker

			NOTE: This script tries to mimic the typical usage for configure scripts
			generated by autotools, hence it will silently ignore unrecognized
			command line options.
			EOF
			exit
			;;
		*) true ;;
	esac
	shift
done

if test -z "${opt_libdir}" ; then
	opt_libdir="${opt_prefix}/lib"
fi
if test -z "${opt_bindir}" ; then
	opt_bindir="${opt_prefix}/bin"
fi

for dirpath in "${opt_prefix}" "${opt_libdir}" "${opt_bindir}"; do
	if  ! echo "${dirpath}" | grep -q "^/"; then
		echo "configure: error: expected an absolute directory name for ${dirpath}" 1>&2
		exit 1
	fi
done

tee config.mk <<EOF
#---------------#
# Build options #
#---------------#
PREFIX   = ${opt_prefix}
LIBDIR   = ${opt_libdir}
BINDIR   = ${opt_bindir}
CFLAGS   = ${opt_cflags}
CXXFLAGS = ${opt_cxxflags}
LDFLAGS  = ${opt_ldflags}
EOF
